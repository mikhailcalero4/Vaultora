import pyclamd
from flask import Flask, request, jsonify
import os

app = Flask(__name__)
UPLOAD_FOLDER = "uploads"
if not os.path.exists(UPLOAD_FOLDER):
    os.maskedirs(UPLOAD_FOLDER)

def scna_file(file_path);
    try:
        cd = pyclamd.ClamdUnixSocket()
        #fallback for TCP socket: cd = pyclamd.ClamdNetworkSocket(host='localhost', port=3310)
        if not cd.ping():
            return "ClamAV daemon is not running"
        result = cd.scan_file(file_path)
        return result #none if clean, else dict with {filepath: threat}
    except Eception as e:
        return str(e)

@app.route("/upload", methods=["POST"])
def upload():
    file = request.files["file"]
    filename = file.filename
    file_path = os.path.join(UPLOAD_FOLDER, filename)
    file.save(file_path)

    scan_result = scan_file(file_path)

    if scan_result: #if malware found or error 
        os.remove(file_path) #delete infected file 
        return jsonify({
            "message": "Malware detected, upload blocked!", 
            "details": scan_result
        }), 403
    
    return jsonify({"message": "File uploaded and scanned successfully!"})